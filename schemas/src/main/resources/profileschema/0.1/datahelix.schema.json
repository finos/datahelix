{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "http://scottlogic.com/datahelix.json",
  "definitions": {

    "schemaVersion": {
      "type": "string",
      "title": "The version of the DataHelix profile schema",
      "pattern": "^[0-9]+[.][0-9]+$"
    },

    "temporal": {
      "type": "object",
      "additionalProperties": false,
      "required": ["date"],
      "properties": {
        "date": {
          "type": "string",
          "title": "an ISO 8610 compatible string denoting a date and time",
          "pattern": "^[0-9]{4}-([0][0-9]|[1][0-2])-([0-2][0-9]|3[01])T([0-1][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9][.][0-9]{3}$"
        }
      }
    },

    "fieldName": {
      "title": "The name of a field to generate data for",
      "type": "object",
      "additionalProperties": false,
      "required": ["name"],
      "properties": {
        "name": {"type": "string"}
      }
    },

    "constraint": {
      "oneOf": [
        {
          "$ref": "#/definitions/grammaticalConstraint"
        },
        {
          "$ref": "#/definitions/dataConstraint"
        }
      ]
    },

    "grammaticalConstraint": {
      "oneOf": [
        {
          "$ref": "#/definitions/notConstraint"
        },
        {
          "$ref": "#/definitions/anyOfConstraint"
        },
        {
          "$ref": "#/definitions/allOfConstraint"
        },
        {
          "$ref": "#/definitions/ifConstraint"
        }
      ]
    },

    "dataConstraint": {
      "type": "object",
      "additionalProperties": false,
      "required": ["field", "is"],
      "properties": {
        "field": {"type": "string"},
        "is": {
          "enum": [
            "ofType", "equalTo", "aValid", "inSet",
            "formattedAs", "matchingRegex", "containingRegex", "ofLength", "longerThan", "shorterThan",
            "null",
            "greaterThan", "lessThan", "greaterThanOrEqualTo", "lessThanOrEqualTo", "granularTo"
          ]
        }
      },
      "anyOf": [
        {
          "if": {
            "properties": {"is": {"const": "equalTo"}}
          },
          "then": {
            "properties": {"value": {}}
          }
        },
        {
          "if": {
            "properties": {"is": {"const": "ofType"}}
          },
          "then": {
            "properties": {"value": {"enum": ["decimal", "integer", "string", "temporal"]}}
          }
        },
        {
          "if": {
            "properties": {"is": {"const": "inSet"}}
          },
          "then": {
            "properties": {"values": {"type": "array"}}
          }
        },
        {
          "if": {
            "properties": {"is": {"const": "null"}}
          },
          "then": {
            "properties": {"not": {}}
          }
        },
        {
          "if": {
            "properties": {"is": {"const": "formattedAs"}}
          },
          "then": {
            "properties": {"value": {"pattern": "^%.+$"}}
          }
        },
        {
          "if": {
            "properties": {"is": {"enum": ["matchingRegex", "containingRegex"]}}
          },
          "then": {
            "properties": {"value": {"type": "string"}}
          }
        },
        {
          "if": {
            "properties": {
              "is": {
                "enum": [
                  "shorterThan", "longerThan", "greaterThan", "lessThan", "greaterThanOrEqualTo", "lessThanOrEqualTo", "granularTo",
                  "ofLength"
                ]
              }
            }
          },
          "then": {
            "properties": {"value": {"type": "number"}}
          }
        },
        {
          "if": {
            "properties": {"is": {"const": "aValid"}}
          },
          "then": {
            "properties": {"value": {"pattern": "^ISIN$"}}
          }
        }
      ]
    },

    "notConstraint": {
      "type": "object",
      "additionalProperties": false,
      "required": ["not"],
      "properties": {
        "not": {"$ref": "#/definitions/constraint"}
      }
    },

    "anyOfConstraint": {
      "type": "object",
      "additionalProperties": false,
      "required": ["anyOf"],
      "properties": {
        "anyOf": {
          "type": "array",
          "minItems": 2,
          "items": {
            "$ref": "#/definitions/constraint"
          }
        }
      }
    },

    "allOfConstraint": {
      "type": "object",
      "additionalProperties": false,
      "required": ["allOf"],
      "properties": {
        "allOf": {
          "type": "array",
          "minItems": 2,
          "items": {
            "$ref": "#/definitions/constraint"
          }
        }
      }
    },

    "ifConstraint": {
      "type": "object",
      "required": ["if", "then"],
      "properties": {
        "if": {
          "$ref": "#/definitions/constraint"
        },
        "then": {
          "$ref": "#/definitions/constraint"
        },
        "else": {
          "$ref": "#/definitions/constraint"
        }
      }
    }
  },

  "type": "object",
  "additionalProperties": false,
  "required": ["schemaVersion", "fields", "rules"],
  "title": "The Scott Logic DataHelix Profile Schema",
  "properties": {

    "schemaVersion": {
      "$ref": "#/definitions/schemaVersion"
    },

    "description": {
      "type": "string",
      "title": "A description of what data the profile is modelling"
    },

    "fields": {
      "type": "array",
      "minItems": 1,
      "uniqueItems": true,
      "title": "Defines the fields that data will be produced for. field names must begin with an alphabetic character.",
      "items": {
        "$ref": "#/definitions/fieldName"
      }
    },

    "rules": {
      "type": "array",
      "minItems": 1,
      "title": "The Rules defining the data to be output",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["constraints"],
        "title": "A set of Rule objects.",
        "properties": {
          "rule": {
            "type": "string",
            "title": "A collection of constraints. Test case generation revolves around rules, in that the generator will output a separate dataset for each rule, wherein each row violates the rule in a different way."
          },
          "constraints": {
            "type": "array",
            "minItems": 1,
            "items": {"$ref": "#/definitions/constraint"}
          }
        }
      }
    }
  }
}